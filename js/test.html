<!DOCTYPE html>
<html>
	<head>
		<title>CBOR tests</title>
	</head>
	<body>
		<script>
			addEventListener('error', event => {
				document.body.innerHTML = '‚ùå failed';
			});
		</script>
		<script src="cbor.js"></script>
		<script>
			let tests = [
				// from RFC-7049 Appendix A
				{cbor: "00", data: 0, roundTrip: true},
				{cbor: "01", data: 1, roundTrip: true},
				{cbor: "0a", data: 10, roundTrip: true},
				{cbor: "17", data: 23, roundTrip: true},
				{cbor: "1818", data: 24, roundTrip: true},
				{cbor: "1819", data: 25, roundTrip: true},
				{cbor: "1864", data: 100, roundTrip: true},
				{cbor: "1903e8", data: 1000, roundTrip: true},
				{cbor: "1a000f4240", data: 1000000, roundTrip: true},
				{cbor: "1b000000e8d4a51000", data: 1000000000000, roundTrip: true},
				{cbor: "1bffffffffffffffff", data: 18446744073709551615n, roundTrip: true},
				{cbor: "c249010000000000000000", data: 18446744073709551616n, roundTrip: true},
				{cbor: "3bffffffffffffffff", data: -18446744073709551616n, roundTrip: true},
				{cbor: "c349010000000000000000", data: -18446744073709551617n, roundTrip: true},
				{cbor: "20", data: -1, roundTrip: true},
				{cbor: "29", data: -10, roundTrip: true},
				{cbor: "3863", data: -100, roundTrip: true},
				{cbor: "3903e7", data: -1000, roundTrip: true},
				{cbor: "fb3ff199999999999a", data: 1.1, roundTrip: true},
				{cbor: "f93e00", data: 1.5, roundTrip: false},
				{cbor: "fa7f7fffff", data: 3.4028234663852886e+38, roundTrip: false},
				{cbor: "fb7e37e43c8800759c", data: 1e+300, roundTrip: true},
				{cbor: "f90001", data: 5.960464477539063e-8, roundTrip: false},
				{cbor: "f90400", data: 0.00006103515625, roundTrip: false},
				{cbor: "fbc010666666666666", data: -4.1, roundTrip: true},
				{cbor: "f97c00", data: Infinity, roundTrip: false},
				{cbor: "f97e00", data: NaN, roundTrip: false},
				{cbor: "f9fc00", data: -Infinity, roundTrip: false},
				{cbor: "fa7f800000", data: Infinity, roundTrip: false},
				{cbor: "fa7fc00000", data: NaN, roundTrip: false},
				{cbor: "faff800000", data: -Infinity, roundTrip: false},
				{cbor: "fb7ff0000000000000", data: Infinity, roundTrip: false},
				{cbor: "fb7ff8000000000000", data: NaN, roundTrip: false},
				{cbor: "fbfff0000000000000", data: -Infinity, roundTrip: false},
				{cbor: "f4", data: false, roundTrip: true},
				{cbor: "f5", data: true, roundTrip: true},
				{cbor: "f6", data: null, roundTrip: true},
				{cbor: "f7", data: undefined, roundTrip: true},
				{cbor: "60", data: "", roundTrip: true},
				{cbor: "6161", data: "a", roundTrip: true},
				{cbor: "6449455446", data: "IETF", roundTrip: true},
				{cbor: "62225c", data: "\"\\", roundTrip: true},
				{cbor: "62c3bc", data: "√º", roundTrip: true},
				{cbor: "63e6b0b4", data: "Ê∞¥", roundTrip: true},
				{cbor: "64f0908591", data: "êÖë", roundTrip: true},
				{cbor: "470255333a83fb3f", data: new Uint8Array([2,85,51,58,131,251,63]).buffer, roundTrip: true},
				{cbor: "40", data: new Uint8Array([]).buffer, roundTrip: true},
				{cbor: "80", data: [], roundTrip: true},
				{cbor: "83010203", data: [1,2,3], roundTrip: true},
				{cbor: "8301820203820405", data: [1,[2,3],[4,5]], roundTrip: true},
				{cbor: "98190102030405060708090a0b0c0d0e0f101112131415161718181819", data: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25], roundTrip: true},
				{cbor: "9f018202039f0405ffff", data: [1,[2,3],[4,5]], roundTrip: false},
				{cbor: "9f01820203820405ff", data: [1,[2,3],[4,5]], roundTrip: false},
				{cbor: "83018202039f0405ff", data: [1,[2,3],[4,5]], roundTrip: false},
				{cbor: "83019f0203ff820405", data: [1,[2,3],[4,5]], roundTrip: false},
				{cbor: "a0", data: {}, roundTrip: true},
				{cbor: "a26161016162820203", data: {"a":1,"b":[2,3]}, roundTrip: true},
				{cbor: "826161a161626163", data: ["a",{"b":"c"}], roundTrip: true},
				{cbor: "a56161614161626142616361436164614461656145", data: {"a":"A","b":"B","c":"C","d":"D","e":"E"}, roundTrip: true},
				{cbor: "bf61610161629f0203ffff", data: {"a":1,"b":[2,3]}, roundTrip: false},
				{cbor: "826161bf61626163ff", data: ["a",{"b":"c"}], roundTrip: false},
				{cbor: "bf6346756ef563416d7421ff", data: {"Fun":true,"Amt":-2}, roundTrip: false},
				{cbor: "a0", data: {}, roundTrip: true},
				{cbor: "a26161016162820203", data: {"a":1,"b":[2,3]}, roundTrip: true},
				{cbor: "826161a161626163", data: ["a",{"b":"c"}], roundTrip: true},
				{cbor: "a56161614161626142616361436164614461656145", data: {"a":"A","b":"B","c":"C","d":"D","e":"E"}, roundTrip: true},
				{cbor: "bf61610161629f0203ffff", data: {"a":1,"b":[2,3]}, roundTrip: false},
				{cbor: "826161bf61626163ff", data: ["a",{"b":"c"}], roundTrip: false},
				{cbor: "bf6346756ef563416d7421ff", data: {"Fun":true,"Amt":-2}, roundTrip: false},
			];
			
			function assertDeepEqual(a, b) {
				if (Array.isArray(a)) {
					if (!Array.isArray(b)) throw Error("not equal");
					assertDeepEqual(a.length, b.length);
					a.forEach((ai, i) => assertDeepEqual(ai, b[i]));
				} else if (typeof a == 'object') {
					if (typeof b != 'object') throw Error("not equal");
					if (!a && !b) return;
					if (!a != !b) throw Error("not equal");
					assertDeepEqual(Object.keys(a).sort(), Object.keys(b).sort());
					for (let key in a) {
						assertDeepEqual(a[key], b[key]);
					}
				} else if (typeof a == 'number' && typeof b == 'number') {
					if (isNaN(a) && isNaN(b)) return;
					if (a !== b) throw Error("not equal");
				} else {
					if (a !== b) throw Error("not equal");
				}
			}
			
			tests.forEach(test => {
				let hex = test.cbor;
				let bytes = new Uint8Array(hex.length/2);
				for (let i = 0; i < bytes.length; ++i) bytes[i] = parseInt(hex.substr(i*2, 2), 16);
				let ab = bytes.buffer;
				
				console.log("test:", hex, test.data);
				let decoded = CBOR.decode16(hex);
				assertDeepEqual(test.data, decoded);
				
				if (test.roundTrip) {
					let hex2 = CBOR.encode16(test.data);
					if (hex2 != hex) {
						console.error(hex2, hex);
						throw Error("round-trip encode doesn't match");
					}
				}
				
			});
			document.body.innerHTML = '‚úÖ passed';
		</script>
	</body>
</html>
